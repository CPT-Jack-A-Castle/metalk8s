heat_template_version: pike

description: Single VM to be used in a MetalK8s cluster.

parameters:
  access_network_id:
    type: string
    constraints:
      - custom_constraint: neutron.network
  name:
    type: string
  key_pair:
    type: string
    constraints:
      - custom_constraint: nova.keypair
  flavor:
    type: string
    constraints:
      - custom_constraint: nova.flavor
  image:
    type: string
    constraints:
      - custom_constraint: glance.image

resources:
  access_port:
    type: OS::Neutron::Port
    properties:
      name:
        str_replace:
          template: $name-public
          params: { $name: { get_param: name } }
      network: { get_param: access_network_id }
  server:
    type: OS::Nova::Server
    properties:
      name: { get_param: name }
      key_name: { get_param: key_pair }
      flavor: { get_param: flavor }
      image: { get_param: image }
      networks:
        - port: { get_resource: access_port }

outputs:
  OS::stack_id:
    value: { get_resource: server }
  access_ip:
    value: { get_attr: [server, networks, { get_param: access_network_id }, 0] }
