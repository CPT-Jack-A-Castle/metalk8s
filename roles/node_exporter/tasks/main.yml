---
- name: add Prometheus repo key
  rpm_key:
    state: present
    key: "{{ item }}"
    validate_certs: true
  with_items:
    - https://packagecloud.io/prometheus-rpm/release/gpgkey
    - https://raw.githubusercontent.com/lest/prometheus-rpm/master/RPM-GPG-KEY-prometheus-rpm

- name: 'set node exporter repository'
  yum_repository:
    name: prometheus-rpm
    baseurl: https://packagecloud.io/prometheus-rpm/release/el/$releasever/$basearch
    description: prometheus-rpm
    enabled: true
    gpgcheck: true
    gpgkey: https://packagecloud.io/prometheus-rpm/release/gpgkey
    sslverify: true
    sslcacert: /etc/pki/tls/certs/ca-bundle.crt
    repo_gpgcheck: true
    state: present

# https://github.com/ansible/ansible/issues/20711
# For ansible < 2.6
- name: 'rebuild cache'
  command: yum -y makecache --disablerepo='*' --enablerepo=prometheus-rpm
  args:
    creates: /var/lib/yum/repos/{{ ansible_machine }}/{{  ansible_distribution_major_version }}/prometheus-rpm/gpgdir/gpg.conf
    warn: false

- name: 'install version-lock'
  yum:
    name: yum-plugin-versionlock
    state: present

# Unlock before, in case the version of node_exporter has changed,
# otherwise it will prevent the installation of the package,
# even if the versionlock rule is replaced by the new version.
- name: 'unlock version of node_exporter'
  shell: yum versionlock delete node_exporter-*
  failed_when: no

- name: 'install Prometheus Node exporter'
  yum:
    name: node_exporter-{{ node_exporter_version }}
    state: present
    allow_downgrade: yes

- name: 'lock version of node_exporter'
  command: yum versionlock add node_exporter-{{ node_exporter_version }}

- name: 'Start and enable the node_exporter service'
  service:
    name: node_exporter
    enabled: true
    state: started
