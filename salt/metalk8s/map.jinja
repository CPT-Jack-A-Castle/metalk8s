{% import_yaml 'metalk8s/defaults.yaml' as defaults with context %}

{% set defaults = salt['grains.filter_by']({
  'default': defaults
}, merge=salt['pillar.items']()) %}

{% set kubeadm_preflight = salt['grains.filter_by']({
  'default': {}
}, merge=defaults.get('kubeadm_preflight')) %}

{% set repo = salt['grains.filter_by']({
  'RedHat': {
    'containerd': {
      'name': 'epel'
    },
    'kubernetes': {
      'name': 'kubernetes'
    }
  }
}, merge=defaults.get('repo')) %}

{% set networks = salt['grains.filter_by']({
  'default': {}
}, merge=defaults.get('networks')) %}

{% set runc = salt['grains.filter_by']({
  'default': {}
}, merge=defaults.get('runc')) %}

{% set containerd = salt['grains.filter_by']({
  'default': {}
}, merge=defaults.get('containerd')) %}

{% set kubelet = salt['grains.filter_by']({
  'default': {}
}, merge=defaults.get('kubelet')) %}
{% set kubelet = salt['grains.filter_by']({
  'systemd': {
    'service': {
      'config_path': '/etc/systemd/system/kubelet.service.d',
      'config_name': '10-kubeadm.conf'
    }
  }
}, grain='init', merge=kubelet) %}

{% set ca = salt['grains.filter_by']({
  'default': {}
}, merge=defaults.get('ca')) %}

{% set kube_api = salt['grains.filter_by']({
  'default': {}
}, merge=defaults.get('kube_api')) %}

{% set kubeadm_kubeconfig = salt['grains.filter_by']({
  'default': {}
}, merge=defaults.get('kubeadm_kubeconfig')) %}
